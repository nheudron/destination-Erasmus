<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <!-- Nous chargeons les fichiers CDN de Leaflet. Le CSS AVANT le JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
        integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
        crossorigin="" />
    <style type="text/css">
        body {
            margin: 0;
        }

        #search {
            width: 100%;
            height: 20vh;

            position: relative;
        }

        .content {
            margin: 0;
            position: absolute;
            top: 50%;
            left: 50%;
            -ms-transform: translate(-50%, -50%);
            transform: translate(-50%, -50%);
        }

        .mapdescritpion {
            display: flex;
            flex-direction: row;
            width: 100%;
            height: 80vh;
        }

        .description {
            height: 80vh;
            width: 40vw;
        }

        .description h2 {
            text-align: center;
        }

        .description table {
            width: 100%;
        }

        #nom {
            width: 50%;
        }

        #coord {
            width: 40%;
        }

        #button {
            width: 10%;
        }

        #map {
            /* la carte DOIT avoir une hauteur sinon elle n'apparaît pas */
            width: 60vw;
            height: 80vh;
        }
    </style>
    <title>Carte</title>
</head>

<body>
    <div id="search">
        <div class="content">
            <form onsubmit="searchOPSM();return false">
                <input type="text" id="searchtext" placeholder="Endroit à rechercher">
                <input type="submit" value="Rechercher">
            </form>
        </div>
    </div>
    <div class="mapdescritpion">
        <div class="description">
            <h2>Résultats de la recherche :</h2>
            <table id="searchResults">
                <tr>
                    <th id="nom">nom</th>
                    <th id="coord">lat,lon</th>
                    <th id="button">Voir sur la carte</th>
                </tr>
            </table>
        </div>
        <div id="map">
            <!-- Ici s'affichera la carte -->
        </div>
    </div>

    <!-- Fichiers Javascript -->
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
        integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
        crossorigin="">
        </script>

    <script type="text/javascript">
        var univs = {
            "Esaip Angers": { "lat": 47.463972, "lon": -0.497227 },
            "Esaip Aix-en-Provence": { "lat": 43.5276723, "lon": 5.4314262 },
            "Université de Veliko Tarnovo": { "lat": 43.0783, "lon": 25.6492 }
        }
        // On initialise la latitude et la longitude de l'ESAIP (centre de la carte)
        var lat = 47.463972;
        var lon = -0.497227;
        var macarte = null;

        var recherche = null;

        var redIcon = L.icon({
            iconUrl: "marker-iconRed.png",
            shadowUrl: "marker-shadow.png",
            iconSize: [25, 41],
            shadowSize: [41, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34]
        });

        function searchOPSM() {
            var search = document.getElementById("searchtext").value;
            var searchbaseurl = "https://nominatim.openstreetmap.org/search?format=json&q=";
            var url = searchbaseurl + search;
            var httpreq = new XMLHttpRequest();
            httpreq.overrideMimeType("application/json");
            httpreq.open("GET", url, true);
            httpreq.onload = function () {
                var jsonResponse = JSON.parse(httpreq.responseText);
                updatetext(jsonResponse);
            };
            httpreq.send(null);
        }

        function updatetext(jsonObjects) {
            var searchResults = document.getElementById("searchResults");
            while (searchResults.rows.length > 1) {
                searchResults.deleteRow(1);
            }
            for (let index = 0; index < jsonObjects.length; index++) {
                let ligne = searchResults.insertRow();
                let cellule1 = ligne.insertCell();
                let nom = document.createTextNode(jsonObjects[index].display_name);
                cellule1.appendChild(nom);
                let cellule2 = ligne.insertCell();
                let coord = document.createTextNode(jsonObjects[index].lat + "," + jsonObjects[index].lon);
                cellule2.appendChild(coord);
                let cellule3 = ligne.insertCell();
                var button = document.createElement('BUTTON');
                let textbutton = document.createTextNode("Voir");
                button.appendChild(textbutton);
                button.setAttribute("onclick", "addtoMap(this)");
                cellule3.appendChild(button);
            }
        }

        function addtoMap(button) {
            recherche.clearLayers();
            let obj = button.parentNode.parentNode;
            let coord = obj.children[1].innerHTML.split(',');
            let name = obj.children[0].innerHTML.split(',')[0];
            var marker = L.marker(coord, { icon: redIcon }).addTo(recherche);
            marker.bindPopup(name);
            macarte.setView(coord, 15);
        }

        // Fonction d'initialisation de la carte
        function initMap() {
            // Créer l'objet "macarte" et l'insèrer dans l'élément HTML qui a l'ID "map"
            macarte = L.map('map').setView([lat, lon], 6);
            // Leaflet ne récupère pas les cartes (tiles) sur un serveur par défaut. Nous devons lui préciser où nous souhaitons les récupérer. Ici, openstreetmap.fr
            L.tileLayer('https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png', {
                // Il est toujours bien de laisser le lien vers la source des données
                attribution: 'données © <a href="//osm.org/copyright">OpenStreetMap</a>/ODbL - rendu <a href="//openstreetmap.fr">OSM France</a> - <a href="https://www.openstreetmap.org/copyright">© les contributeurs d’OpenStreetMap</a>',
                minZoom: 3,
                maxZoom: 20
            }).addTo(macarte);
            var universityLayer = L.layerGroup().addTo(macarte);
            recherche = L.layerGroup().addTo(macarte);
            for (univ in univs) {
                var marker = L.marker([univs[univ].lat, univs[univ].lon]).addTo(universityLayer);
                marker.bindPopup(univ);
            }
        }

        window.onload = function () {
            // Fonction d'initialisation qui s'exécute lorsque le DOM est chargé
            initMap();
        };
    </script>
</body>

</html>